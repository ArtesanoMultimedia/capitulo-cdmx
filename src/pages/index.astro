---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Cap铆tulo: CDMX">
  <main class="min-h-screen flex flex-col items-center justify-center bg-[#000000] relative overflow-hidden font-playfair transition-opacity duration-2000" id="main-container">
    
    <!-- PHASE 1: UNLOCK -->
    <div id="ui-wrapper" class="relative z-20 w-full max-w-sm px-8 transition-all duration-[3000ms]">
      <form id="unlockForm" class="space-y-12 group flex flex-col items-center">
        
        <div class="relative text-center flex flex-col items-center gap-6 w-full">
          <label for="secretCode" class="text-cream/60 text-[10px] tracking-[0.4em] uppercase font-medium">
            CDIGO DE REGALO
          </label>
          
          <div class="relative w-full">
            <input
              type="text"
              id="secretCode"
              placeholder="XXX-XXXX-XXXXXX"
              class="w-full bg-transparent border-none text-cream text-center text-xl md:text-2xl py-4 px-2 focus:outline-none placeholder:text-cream/50 tracking-[0.15em] font-light uppercase transition-all duration-500"
              autocomplete="off"
              maxlength="15"
            />
            <div id="line" class="absolute bottom-0 left-1/2 -translate-x-1/2 w-8 h-px bg-cream/30 transition-all duration-[1500ms] group-focus-within:w-full group-focus-within:bg-gold-old"></div>
          </div>
        </div>

        <button 
          id="submitBtn"
          type="submit"
          class="opacity-0 pointer-events-none translate-y-4 px-8 py-3 border border-gold-old/30 text-gold-old text-[10px] tracking-[0.3em] uppercase hover:bg-gold-old/10 hover:border-gold-old/60 transition-all duration-700 ease-out"
        >
          Canjear Regalo
        </button>
        
        <div class="h-4 text-center">
          <p id="errorMessage" class="text-gold-old/80 text-[10px] tracking-[0.3em] opacity-0 transition-opacity duration-[1000ms] italic">
            C贸digo no encontrado
          </p>
        </div>
      </form>
    </div>

    <!-- DEBUG CONTROLS (Always visible when DEBUG_MODE = true) -->
    <div id="debug-controls" class="hidden fixed top-4 right-4 z-[200] flex flex-col items-end pointer-events-auto gap-2">
      <button id="btn-skip-to-story" class="bg-blue-900/80 text-white text-[10px] px-3 py-2 rounded uppercase tracking-widest border border-blue-500/50 hover:bg-blue-700 shadow-lg backdrop-blur-md transition-colors">
        锔 Omitir hasta "Estoy lista"
      </button>
      <div class="flex gap-2">
        <button id="btn-record-timestamp" class="bg-red-900/80 text-white text-[10px] px-3 py-2 rounded uppercase tracking-widest border border-red-500/50 hover:bg-red-700 shadow-lg backdrop-blur-md transition-colors">
           REC
        </button>
      </div>
      <div class="bg-black/50 backdrop-blur-md border border-gold-old/20 rounded p-4 text-right">
        <div id="live-timer" class="text-4xl text-gold-old font-mono font-bold tabular-nums tracking-tighter leading-none">0.00</div>
        <div id="last-timestamp" class="text-[10px] text-cream/50 mt-1 font-mono">ltimo REC: 0.00s</div>
      </div>
    </div>

    <!-- PHASE 2: STORY (Hidden initially) -->
    <div id="story-wrapper" class="hidden absolute inset-0 z-30 h-full w-full bg-[#050505] overflow-hidden selection:bg-gold-old/20 cursor-crosshair opacity-0 transition-opacity duration-[2000ms]">

      <button 
        id="playback-control" 
        class="fixed bottom-8 right-8 z-[100] text-gold-old/50 hover:text-gold-old transition-all duration-500 opacity-0 pointer-events-none hover:scale-110 focus:outline-none"
        aria-label="Pausar o reanudar"
      >
        <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
        <svg id="icon-play" class="hidden" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
      </button>

      <div id="orb-container" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 scale-50 transition-all duration-[5000ms] ease-out will-change-transform">
        <div id="orb" class="w-24 h-24 rounded-full bg-radial-gradient from-gold-old to-transparent blur-xl opacity-30 transition-transform duration-100 ease-out will-change-transform"></div>
      </div>

      <div id="ui-layer" class="relative z-50 h-full w-full flex flex-col items-center justify-center text-center">
        <div id="sequence-container" class="absolute inset-0 flex flex-col items-center justify-center transition-all duration-1000 z-50 px-6">
          <h2 id="seq-text" class="text-cream/80 text-xl md:text-2xl tracking-[0.1em] italic font-light leading-relaxed min-h-[80px] max-w-2xl transition-opacity duration-1000 text-balance"></h2>
          
          <div id="seq-btn-container" class="mt-12 h-16 flex items-center justify-center z-50">
            <button id="seq-btn" class="opacity-0 pointer-events-none px-8 py-3 text-gold-old border border-gold-old/30 bg-gold-old/5 hover:bg-gold-old/10 hover:border-gold-old/60 hover:scale-105 rounded-sm transition-all duration-500 text-[11px] tracking-[0.3em] uppercase outline-none shadow-[0_0_15px_rgba(212,175,55,0.05)]">
            </button>
          </div>
        </div>

        <div id="lyrics-container" class="absolute inset-0 flex items-center justify-center pointer-events-none z-30 px-8">
          <p id="lyrics-text" class="text-cream/90 text-2xl md:text-4xl tracking-[0.1em] md:tracking-[0.2em] italic font-light opacity-0 transform scale-95 transition-all duration-[3000ms] ease-out text-balance text-center leading-snug absolute"></p>
          <img id="lyrics-image" src="" alt="Moment" class="w-64 md:w-80 h-auto rounded shadow-2xl opacity-0 transform scale-95 transition-all duration-[3000ms] ease-out border border-gold-old/20 absolute object-cover" />
        </div>

        <div id="phase-final" class="hidden absolute inset-0 flex flex-col items-center justify-center space-y-16 opacity-0 transition-opacity duration-[5000ms] z-40 px-6">
          <h2 class="text-3xl md:text-5xl font-light tracking-[0.2em] text-cream italic animate-fade-in-up text-balance text-center">驴Conspiramos?</h2>
          <a id="cta-whatsapp" href="https://wa.me/34665966050?text=He%20escuchado%20la%20historia.%20Estoy%20lista%20para%20conspirar." target="_blank" class="pointer-events-auto px-12 py-5 border border-gold-old/40 text-gold-old bg-gold-old/5 hover:bg-gold-old/10 hover:border-gold-old hover:scale-105 transition-all duration-700 text-[11px] tracking-[0.4em] uppercase italic relative group shadow-[0_0_20px_rgba(212,175,55,0.1)]">
            <span class="relative z-10">Fijar fecha</span>
          </a>
        </div>
      </div>

      <audio id="narracion" src="/CapituloCDMX.mp3" preload="auto"></audio>
    </div>
  </main>
</Layout>

<style>
  .bg-radial-gradient { background: radial-gradient(circle at center, var(--tw-gradient-from), var(--tw-gradient-to)); }
  
  /* Animaci贸n de caracteres */
  :global(.char-reveal) { opacity: 0; display: inline-block; filter: blur(4px); transition: opacity 0.8s ease, filter 0.8s ease, transform 0.8s ease; transform: translateY(5px); }
  :global(.char-visible) { opacity: 1; filter: blur(0); transform: translateY(0); }
  
  /* Contenedor de palabra indivisible */
  :global(.word-wrapper) {
    display: inline-block;
    white-space: nowrap; 
  }
</style>

<script>
  // ==========================================
  // 锔 CONFIGURACIN
  // ==========================================
  const SECRET_CODE = 'NHI-CDMX-050326'; 
  const DEBUG_MODE = false; 
  const LOOP_START = 296; 
  const LOOP_END = 346;   
  const NARRATION_START_TIME = 24; 
  const SHOW_CTA_AT = 244.42; // Tiempo ajustado manualmente
  
  const PREP_SEQUENCE = [
    { text: "Hola amor, te estaba esperando...", type: 'auto', duration: 4000 },
    { text: "Antes de empezar, necesito que te prepares.", type: 'auto', duration: 4000 },
    { text: "Ponte los auriculares para escucharme.", type: 'manual', btn: "Los tengo" },
    { text: "Sube el volumen.", type: 'manual', btn: "Ya oigo la m煤sica" },
    { text: "Busca un lugar tranquilo e 铆ntimo...<br>y ponte c贸moda. Te espero.", type: 'manual', btn: "Estoy lista" }
  ];

  const LYRICS = [
    { time: 16.87, text: "Ya falta poco" },
    { time: 27.1, text: "Rebeld铆a" },
    { time: 38.21, text: "Contra el tiempo y la distancia" },
    { time: 45.6, text: "Piel con piel" },
    { time: 50.49, text: "Todo." },
    { time: 54.99, text: "Nuevo cap铆tulo" },
    { time: 61.57, text: "Imagina..." },
    { time: 66.21, text: "Perdernos para encontrarnos" },
    { time: 74.17, image: "/assets/escape.jpg" },
    { time: 86.95, text: "San Valent铆n a nuestro aire" },
    { time: 90.85, image: "/assets/cena.webp" },
    { time: 99.67, text: "Apagar las pantallas" },
    { time: 109.71, image: "/assets/ceramica.jpg" },
    { time: 127.96, text: "Parar el reloj" },
    { time: 132.36, image: "/assets/masaje.jpg" },
    { time: 142.09, text: "Todo contigo" },
    { time: 144.26, text: "Todo." },
    { time: 149.57, text: "Siempre contigo" },
    { time: 155.5, text: "Siempre." },
    { time: 160.57, text: "No todo lo dejo abierto..." },
    { time: 167.49, text: "ESCENA 1: Presentaci贸n" },
    { time: 178.12, text: "Brindis" },
    { time: 185.18, text: "Memoria" },
    { time: 191.18, text: "Sorpresa final" },
    { time: 201.16, text: "Posibilidades" },
    { time: 208.37, text: "Decidir juntos" },
    { time: 213.57, text: "Imaginar contigo" },
    { time: 216.73, text: "Construir contigo" },
    { time: 221.41, text: "Escribir contigo." },
    { time: 242.18, text: "Te amo..." }
  ];

  // --- ELEMENTS ---
  const form = document.getElementById('unlockForm') as HTMLFormElement;
  const input = document.getElementById('secretCode') as HTMLInputElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const errorMessage = document.getElementById('errorMessage') as HTMLParagraphElement;
  const wrapper = document.getElementById('ui-wrapper');
  const main = document.getElementById('main-container');
  const storyWrapper = document.getElementById('story-wrapper');

  const audio = document.getElementById('narracion') as HTMLAudioElement;
  const orb = document.getElementById('orb');
  const orbContainer = document.getElementById('orb-container');
  const seqContainer = document.getElementById('sequence-container');
  const seqText = document.getElementById('seq-text');
  const seqBtn = document.getElementById('seq-btn');
  const lyricsEl = document.getElementById('lyrics-text');
  const imageEl = document.getElementById('lyrics-image') as HTMLImageElement; 
  const phaseFinal = document.getElementById('phase-final');
  
  const playbackControl = document.getElementById('playback-control');
  const iconPlay = document.getElementById('icon-play');
  const iconPause = document.getElementById('icon-pause');
  const liveTimer = document.getElementById('live-timer');

  let audioCtx: AudioContext;
  let analyser: AnalyserNode;
  let dataArray: Uint8Array;
  let isCoreExperience = false;
  let lastLyricIndex = -1;

  // --- DEBUG SETUP ---
  let recordedTimes: {time: number, text: string}[] = [];

  if (DEBUG_MODE) {
      const debugUI = document.getElementById('debug-controls');
      const debugBtn = document.getElementById('btn-record-timestamp');
      const debugLast = document.getElementById('last-timestamp');
      const skipBtn = document.getElementById('btn-skip-to-story');
      
      if (debugUI) debugUI.classList.remove('hidden');

      // Skip button - salta directamente a la experiencia principal
      skipBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        
        // Simular que se introdujo el c贸digo correcto
        if (wrapper && storyWrapper) {
          wrapper.classList.add('opacity-0', 'scale-95', 'blur-sm');
          setTimeout(() => {
            wrapper.remove();
            storyWrapper.classList.remove('hidden');
            void storyWrapper.offsetWidth;
            storyWrapper.classList.add('opacity-100');
          }, 500);
        }
        
        // Iniciar audio en loop
        audio.volume = 0;
        audio.currentTime = LOOP_START;
        audio.play().then(() => {
          let startT = performance.now();
          const dur = 2000;
          function step(cur: number) {
            const prog = Math.min((cur - startT) / dur, 1);
            audio.volume = Math.pow(prog, 2);
            if(prog < 1) requestAnimationFrame(step);
          }
          requestAnimationFrame(step);
          
          // Saltar directamente a la experiencia principal despu茅s de 1 segundo
          setTimeout(() => {
            startCoreExperience();
          }, 1000);
        });
      });

      const recordTime = () => {
        const t = parseFloat(audio.currentTime.toFixed(2));
        const nextIndex = recordedTimes.length; 
        const placeholderText = nextIndex < LYRICS.length ? LYRICS[nextIndex].text || "IMAGEN" : "BOTN FINAL";
        recordedTimes.push({ time: t, text: placeholderText });
        if (debugLast) debugLast.innerText = `ltimo REC: ${t}s`;
        console.clear();
        console.log(JSON.stringify(recordedTimes, null, 2));
        document.body.style.backgroundColor = '#220000';
        setTimeout(() => document.body.style.backgroundColor = '#050505', 100);
      };

      debugBtn?.addEventListener('click', (e) => { e.stopPropagation(); recordTime(); });
      document.addEventListener('keydown', (e) => { 
        if (e.code === 'Space' && isCoreExperience) { e.preventDefault(); recordTime(); }
      });
  }

  // --- MSCARA Y VISIBILIDAD DE BOTN (Phase 1) ---
  input?.addEventListener('input', (e: Event) => {
    const target = e.target as HTMLInputElement;
    const inputType = (e as InputEvent).inputType;
    
    if (target.value.length > 0) {
        submitBtn.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
    } else {
        submitBtn.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
    }

    if (inputType === 'deleteContentBackward') return;

    let raw = target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    let formatted = '';
    
    if (raw.length > 0) formatted = raw.slice(0, 3);
    if (raw.length >= 3) formatted += '-' + raw.slice(3, 7);
    if (raw.length >= 7) formatted += '-' + raw.slice(7, 13);

    target.value = formatted;
  });

  // --- VALIDACIN Y TRANSICIN (Phase 1 to 2) ---
  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    const code = input.value.trim();
    
    if (code === SECRET_CODE || code === 'INCENDIO') {
      // 1. INICIAR AUDIO INMEDIATAMENTE (Gesto de Usuario!)
      audio.volume = 0;
      audio.currentTime = LOOP_START;
      audio.play().then(() => {
          // Fade in logar铆tmico inicial
          let startT = performance.now();
          const dur = 4000;
          function step(cur: number) {
              const prog = Math.min((cur - startT) / dur, 1);
              audio.volume = Math.pow(prog, 2);
              if(prog < 1) requestAnimationFrame(step);
          }
          requestAnimationFrame(step);
          
          // Iniciar secuencia de preparaci贸n
          setTimeout(() => { playSequenceStep(0); }, 1000);
      }).catch(err => console.error("Audio block:", err));

      // 2. Transici贸n Visual
      wrapper?.classList.add('opacity-0', 'scale-95', 'blur-sm');
      setTimeout(() => {
        wrapper?.remove();
        storyWrapper?.classList.remove('hidden');
        void storyWrapper?.offsetWidth;
        storyWrapper?.classList.add('opacity-100');
        
        // Enfocar para futuros eventos si es necesario
        window.focus();
      }, 1000); 

    } else {
      errorMessage.classList.remove('opacity-0');
      form.animate([
        { transform: 'translateX(0)' },
        { transform: 'translateX(-5px)' },
        { transform: 'translateX(5px)' },
        { transform: 'translateX(0)' }
      ], { duration: 300 });

      setTimeout(() => {
        errorMessage.classList.add('opacity-0');
        input.value = '';
        submitBtn.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
      }, 2000);
    }
  });

  // --- LGICA DE LA HISTORIA (Phase 2) ---

  function initAudioContext() {
    if (audioCtx) return;
    const AudioContext = (window as any).AudioContext || (window as any).webkitAudioContext;
    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    const source = audioCtx.createMediaElementSource(audio);
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    analyser.smoothingTimeConstant = 0.88; 
    analyser.fftSize = 256;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    visualize();
  }

  function visualize() {
    requestAnimationFrame(visualize);
    if (!analyser || audio.paused) return;
    analyser.getByteFrequencyData(dataArray);
    let sum = 0;
    for(let i = 0; i < 40; i++) { sum += dataArray[i]; }
    const average = sum / 40;
    const scale = 1 + (average / 256) * 0.8;
    const opacity = 0.3 + (average / 256) * 0.6;
    const blur = 20 + (average / 256) * 30;
    if (orb) {
      orb.style.transform = `scale(${scale})`;
      orb.style.opacity = opacity.toString();
      orb.style.filter = `blur(${blur}px)`;
      orb.style.boxShadow = `0 0 ${average * 2}px rgba(212, 175, 55, ${opacity * 0.4})`;
    }
  }

  function fadeVolume(targetVol: number, duration: number, onComplete?: () => void) {
    const startVol = audio.volume;
    const startTime = performance.now();
    function step(currentTime: number) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const newVol = startVol + (targetVol - startVol) * progress;
      audio.volume = Math.max(0, Math.min(1, newVol));
      if (progress < 1) { requestAnimationFrame(step); } else { if (onComplete) onComplete(); }
    }
    requestAnimationFrame(step);
  }

  function typeText(element: HTMLElement, htmlContent: string, speed: number = 50) { 
     return new Promise<void>((resolve) => {
      element.innerHTML = "";
      element.style.opacity = '1';
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlContent;
      const nodes = Array.from(tempDiv.childNodes);
      let charIndex = 0;
      let totalChars = 0;

      nodes.forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) {
           const text = node.textContent || "";
           const words = text.split(' ');
           words.forEach((wordText, i) => {
              const wordWrapper = document.createElement('span');
              wordWrapper.className = 'word-wrapper';
              const chars = wordText.split('');
              chars.forEach(char => {
                  const span = document.createElement('span');
                  span.textContent = char;
                  span.className = 'char-reveal';
                  span.style.transitionDelay = `${charIndex * speed}ms`;
                  wordWrapper.appendChild(span);
                  charIndex++;
              });
              element.appendChild(wordWrapper);
              totalChars += chars.length;
              if (i < words.length - 1) {
                  element.appendChild(document.createTextNode(' '));
              }
           });
        } else { 
            element.appendChild(node.cloneNode(true)); 
        }
      });

      void element.offsetWidth;
      const chars = element.querySelectorAll('.char-reveal');
      chars.forEach(c => c.classList.add('char-visible'));
      setTimeout(resolve, (totalChars * speed) + 1000);
    });
  }

  async function fadeOutText(element: HTMLElement) {
     element.style.opacity = '0';
     return new Promise(r => setTimeout(r, 1000));
  }

  async function playSequenceStep(index: number) {
    if (index >= PREP_SEQUENCE.length) { startCoreExperience(); return; }
    const step = PREP_SEQUENCE[index];
    if (seqBtn) { seqBtn.style.opacity = '0'; seqBtn.style.pointerEvents = 'none'; seqBtn.innerText = ""; }
    if (seqText) { if (index > 0) await fadeOutText(seqText); await new Promise(r => setTimeout(r, 300)); await typeText(seqText, step.text, 40); }
    if (step.type === 'auto') { setTimeout(() => { playSequenceStep(index + 1); }, 2000); } 
    else if (step.type === 'manual' && seqBtn && step.btn) {
       setTimeout(() => { seqBtn.innerText = step.btn!; seqBtn.style.opacity = '1'; seqBtn.style.pointerEvents = 'auto'; }, 500);
       const handler = (e: Event) => { e.stopPropagation(); e.preventDefault(); seqBtn.removeEventListener('click', handler); playSequenceStep(index + 1); };
       seqBtn.addEventListener('click', handler);
    }
  }

  function startCoreExperience() {
     if (seqContainer) { seqContainer.style.opacity = '0'; seqContainer.style.pointerEvents = 'none'; setTimeout(() => seqContainer.remove(), 2000); }
     initAudioContext();
     
     fadeVolume(0, 2500, () => {
        isCoreExperience = true;
        
        // Cambiar a la narraci贸n final y empezar desde el principio
        audio.src = '/narracion.mp3';
        audio.currentTime = 0; 
        audio.play();
        
        if (orbContainer) orbContainer.classList.remove('opacity-0', 'scale-50');
        if (playbackControl) {
            playbackControl.classList.remove('opacity-0', 'pointer-events-none');
            playbackControl.classList.add('opacity-100', 'pointer-events-auto');
        }
        fadeVolume(1, 3500);
     });
  }

  audio.addEventListener('timeupdate', () => {
    if (!isCoreExperience) { if (audio.currentTime >= LOOP_END) audio.currentTime = LOOP_START; return; }
    
    const currentTime = audio.currentTime;
    if (DEBUG_MODE && liveTimer) { liveTimer.innerText = currentTime.toFixed(2); }

    const currentLyricIndex = LYRICS.findIndex((l, i) => { const nextL = LYRICS[i + 1]; return currentTime >= l.time && (!nextL || currentTime < nextL.time); });

    if (currentLyricIndex !== -1 && currentLyricIndex !== lastLyricIndex) {
      const lyricData = LYRICS[currentLyricIndex];
      if (Math.abs(currentTime - lyricData.time) < 2) { 
          updateContent(lyricData);
          lastLyricIndex = currentLyricIndex;
      }
    }

    if (currentTime > SHOW_CTA_AT && phaseFinal && phaseFinal.classList.contains('hidden')) {
       phaseFinal.classList.remove('hidden'); void phaseFinal.offsetWidth; phaseFinal.classList.remove('opacity-0', 'pointer-events-none'); phaseFinal.classList.add('opacity-100', 'pointer-events-auto');
       if(lyricsEl) lyricsEl.style.opacity = '0';
       if(imageEl) imageEl.style.opacity = '0';
       if(playbackControl) playbackControl.style.opacity = '0';
    }
  });

  function updateContent(data: {text?: string, image?: string}) {
    if (lyricsEl) { lyricsEl.style.opacity = '0'; lyricsEl.style.transform = 'scale(0.95)'; }
    if (imageEl) { imageEl.style.opacity = '0'; imageEl.style.transform = 'scale(0.95)'; }

    setTimeout(() => {
      if (data.image && imageEl) {
          imageEl.src = data.image;
          imageEl.style.opacity = '1';
          imageEl.style.transform = 'scale(1)';
      } else if (data.text && lyricsEl) {
          typeText(lyricsEl, data.text, 0).then(() => { 
              lyricsEl.style.opacity = '1';
              lyricsEl.style.transform = 'scale(1)';
          });
      }
      setTimeout(() => {
         if (data.text && lyricsEl) { lyricsEl.style.opacity = '0'; }
         if (data.image && imageEl && imageEl.src.includes(data.image)) { imageEl.style.opacity = '0'; }
      }, 5000);
    }, 1000);
  }

  // Playback Control
  playbackControl?.addEventListener('click', (e) => {
    e.stopPropagation(); 
    if (audio.paused) {
      audio.play();
      iconPlay?.classList.add('hidden');
      iconPause?.classList.remove('hidden');
    } else {
      audio.pause();
      iconPause?.classList.add('hidden');
      iconPlay?.classList.remove('hidden');
    }
  });

  // Focus utility
  window.addEventListener('click', () => {
    if (storyWrapper && !storyWrapper.classList.contains('hidden')) return;
    input?.focus();
  });
</script>
